# 开头内容

## 前言

随着我们在机器学习和相关领域面临的问题复杂性不断增加，优化我们对资源的利用和有效地做出知情决策变得越来越重要。贝叶斯优化是一种强大的技术，用于找到昂贵评估的目标函数的最大值和最小值，已经成为解决这一挑战的非常有用的解决方案。其中一个原因是该函数可以被视为黑匣子，这使得研究人员和从业者可以用贝叶斯推断作为主要优化方法来处理非常复杂的函数。

由于其复杂性，贝叶斯优化对于初学者机器学习从业者而言比其他方法更难以掌握。然而，像贝叶斯优化这样的工具必须是任何想要取得最佳结果的机器学习从业者的工具包中的一部分。要精通这个主题，必须对微积分和概率有非常扎实的直觉。

这就是*贝叶斯优化实战*的用武之地。在这本书中，Quan 美妙而成功地揭开了这些复杂概念的神秘面纱。通过实践方法、清晰的图表、真实世界的例子和有用的代码示例，他从理论和实践两个角度剖析了这个主题的复杂性。

Quan 利用他作为数据科学家和教育工作者的丰富经验，给读者提供了这些技术的非常清晰的图景以及它们如何应用于解决实际问题。从贝叶斯推断的原理开始，本书逐渐建立了贝叶斯优化和高斯过程模型的概念。它教授了最先进的库，如 GPyTorch 和 BoTorch，并探讨了它们在几个领域的应用。

这本书是任何数据科学或机器学习从业者必读的书籍，他们想要利用贝叶斯优化真正解决实际问题的潜力。我强烈推荐给任何想通过贝叶斯推断掌握优化艺术的人。

—路易斯·塞拉诺，博士，人工智能科学家和推广者，

*机器学习的领悟者*的作者

工程师和科学家面临着一个共同的挑战，这是捕捉其研究和创造力价值的关键所在。他们需要优化。一个机器学习工程师找到使模型泛化的超参数。一群物理学家调整自由电子激光以获得最大脉冲能量。一个软件工程师配置 JVM 的垃圾收集器以最大化服务器的吞吐量。一个材料科学工程师选择使太阳能电池的光吸收最大化的微观结构形态。在每个例子中，都有不能基于第一原理做出的设计决策。它们取决于实验评估。

要通过实验评估某物，人们可能需要执行软件、运行硬件或构建新物体，同时测量其性能。要找到一个好的设计，就需要进行多次评估。这些评估需要时间、花费金钱，可能还会带来风险。因此，必须尽可能少地进行实验评估以找到最优设计。这就是贝叶斯优化的全部内容。

在过去的 20 年中，我在我的工作中使用了贝叶斯优化和相关的先驱方法。在这段时间里，学术研究和工业应用的报告改善了贝叶斯优化的性能和扩展了其适用性。现在已经存在高质量的软件工具和具有项目特定优化器的技术。

可以将目前的状态类比为使用线性模型进行预测的状态。一个想要构建线性模型的工程师将发现，像 sklearn 这样的软件工具使他们能够设计各种类型（例如连续或分类）和数量的输入和输出变量，执行自动变量选择，并测量一般化的质量。同样地，一个想要构建贝叶斯优化器的工程师将发现，构建在 GPyTorch、pyro 和 PyTorch 之上的 BoTorch 提供了优化不同变量类型、最大化多个目标、处理约束和更多问题的工具。

本书从最基本的组件——高斯过程回归和获取函数的数值优化——开始教授贝叶斯优化，直到最新的处理大量评估（也称为观测）和异类设计空间的方法。在这个过程中，它覆盖了你可能需要的所有特殊化工具：处理约束、多目标、并行化评估和通过成对比较进行评估。你将找到足够的技术深度来让你对工具和方法感到舒适，并且足够的真实代码可以让你快速地将这些工具和方法用于实际工作。

尽管贝叶斯优化取得了很多成就，但鲜有面向新手的文献。这本书很好地填补了这个空缺。

——David Sweet，叶史瓦大学兼职教授

《面向工程师的实验》作者，Cogneato.xyz

## 前言

2019 年秋季，我是一名大一博士生，不确定应该在研究中解决哪个问题。我知道我想要专注于人工智能（AI）——用计算机自动化思考过程很有吸引力——但 AI 是一个庞大的领域，我很难将我的研究范围缩小到一个具体的主题上。

当我参加了一门名为《机器学习的贝叶斯方法》的课程时，所有的不确定性都消失了。在此之前，我在本科阶段曾简要接触过贝叶斯定理，但正是在这门课的第一节讲座中，一切开始变得清晰起来！贝叶斯定理提供了一种直观的思考概率的方式，对我来说，这是一种人类信念的优雅模型：我们每个人都有一个先验信念（关于任何事情），我们从这个先验开始，当我们观察到支持或反对该先验的证据时，我们的信念会更新，结果是反映先验和数据的后验信念。贝叶斯定理将这种保持信念的优雅方式引入到人工智能中，并在许多问题上找到应用，这对我来说是一个强烈的信号，表明贝叶斯机器学习是一个值得追求的主题。

当我们到达关于贝叶斯优化（BayesOpt）的讲座时，我的决定已经做出：理论是直观的，应用是多样的，可以建立的可能性非常大。再次，我内心的某种东西（至今仍然如此）被自动化思维或更具体地说是决策吸引。BayesOpt 正是这个完美的吸引力。我加入了罗曼·加内特（Roman Garnett）教授教授的研究实验室，我的 BayesOpt 之旅开始了！

跳到 2021 年，我花了一些时间研究和实施 BayesOpt 解决方案，我对 BayesOpt 的欣赏只增加了。我会向朋友和同事推荐使用它来处理困难的优化问题，并承诺 BayesOpt 会表现良好。只有一个问题：我找不到一个好的资源可以指向。研究论文数学内容繁重，在线教程太短，无法提供实质性的见解，而 BayesOpt 软件的教程杂乱无章，缺乏良好的叙述。

然后，一个想法浮现在脑海中，以托尼·莫里森（Toni Morrison）的话说，“如果有一本你想读的书，但它还没有被写出来，那么你必须写它。”多么真实啊！这个前景让我兴奋，原因有两个：我可以写一本关于我心爱的事物的书，而写作无疑会帮助我获得更深层次的洞察。我拼凑了一个提案，并联系了曼宁，这是我最喜欢的书籍的出版商，风格正是我所设想的。

2021 年 11 月，我的收购编辑安迪·沃尔德龙（Andy Waldron）给我发了一封电子邮件，标志着曼宁（Manning）的第一次沟通。 2021 年 12 月，我签署了合同并开始写作，这比我最初想象的时间要长（我相信每本书都是如此）。 2023 年 4 月，在出版前的最后几个步骤之一，我写了这篇前言！

## 致谢

抚养一个孩子需要整个村庄的参与，写一本书也是如此。以下只是我自己村庄的一小部分，在写作过程中给予了我巨大帮助的人。

我首先要感谢我的父母 Bang 和 Lan，他们的持续支持使我能够毫无畏惧地探索未知：出国留学；攻读博士学位；当然，还有写书。我还要诚挚地感谢我的姐姐和知己 Nhu，她总是在我最艰难的时刻帮助我。

贝叶斯优化是我博士研究的重要组成部分，我要感谢那些在项目中真正让我的博士经历变得宝贵的人。特别感谢我的指导老师罗曼·加内特，他毫不费力地说服我去从事贝叶斯机器学习的研究。是你开启了这一切。我还要感谢来自主动学习实验室的朋友们：叶虎·陈、沙扬·莫纳德杰米和阿尔维塔·奥特利教授。他们说博士阶段的回报很少，而与你们一起工作正是构成了其中大部分回报。

接下来，我要由衷感谢曼宁公司的出色团队。我感谢我的开发编辑 Marina Michaels，她以最高水平的专业精神、关怀、支持和耐心领导着这艘船，从一开始就与我同舟共济。能够与你配对完成我们的项目，我感到非常幸运。感谢我的收购编辑 Andy Waldron，即使已经有一个更好的作者在写一本类似主题的书，他仍对这个想法充满信心，以及 Ivan Martinovic´，他帮助我解决了 AsciiDoc 的问题，并耐心修复了我的标记代码。

我要感谢审稿人们投入时间和精力，大大提高了写作质量：Allan Makura、Andrei Paleyes、Carlos Aya-Moreno、Claudiu Schiller、Cosimo Attanasi、Denis Lapchev、Gary Bake、George Onofrei、Howard Bandy、Ioannis Atsonios、Jesús Antonino Juárez Guerrero、Josh McAdams、Kweku Reginald Wade、Kyle Peterson、Lokesh Kumar、Lucian Mircea Sasu、Marc-Anthony Taylor、Marcio Nicolau、Max Dehaut、Maxim Volgin、Michele Di Pede、Mirerfan Gheibi、Nick Decroos、Nick Vazquez、Or Golan、Peter Henstock、Philip Weiss、Ravi Kiran Bamidi、Richard Tobias、Rohit Goswami、Sergio Govoni、Shabie Iqbal、Shreesha Jagadeesh、Simone Sguazza、Sriram Macharla、Szymon Harabasz、Thomas Forys 和 Vlad Navitski。

写书时不可避免地会有盲点，而审稿人们帮助填补了这些盲点，并让作者专注于真正重要的事情。衷心感谢 Kerry Koitzsch 提供的有见地的反馈和 James Byleckie 在代码和写作方面提出的优秀建议。

最后，我要感谢 GPyTorch 和 BoTorch 库背后的团队，这些库是为本书开发的代码的主要工作马力。我尝试过各种高斯过程和贝叶斯优化的库，但总是发现自己回到 GPyTorch 和 BoTorch。我希望本书能在这些库周围构建一个已经很棒的社区中发挥作用。

## 关于本书

过去要了解贝叶斯优化，人们需要搜索相关库的在线文章和教程，这些文章和教程零散分布，由于其性质，不会深入探讨具体细节。你也可以求助于技术教材，但它们通常太过密集和数学密集，这对于希望立即着手实践的从业者来说是一个挑战。

本书通过提供一系列实践讨论、对感兴趣的读者的更深入材料的引用以及可直接使用的代码示例来填补这一空白。它首先为贝叶斯优化的组成部分建立直觉，然后使用最先进的软件在 Python 中实现它们。

本书的精神是提供一个以数学和概率的高层次直觉为基础的贝叶斯优化易于理解的介绍。感兴趣的读者可以在全书中找到更多被引用的更深入的技术文本，以深入了解感兴趣的主题。

### 谁应该阅读本书？

对于对超参数调优、A/B 测试或实验以及更一般的决策制定感兴趣的数据科学家和 ML 从业者，本书将有所裨益。

化学、材料科学和物理等科学领域的研究人员面临着困难的优化问题，也会发现本书有所帮助。尽管大多数跟随内容所必需的背景知识将会被涵盖，但读者应该熟悉 ML 中的常见概念，例如训练数据、预测模型、多元正态分布等。

### 本书的组织方式：一条路线图

本书包括四个主要部分。每个部分都包含涵盖相应主题的几章：

+   第一章介绍了使用真实用例的贝叶斯优化。它还包括了一个视觉示例，展示了贝叶斯优化如何加速寻找昂贵函数的全局最优解，而不涉及技术细节。

第一部分涵盖了高斯过程作为我们希望优化的函数的预测模型。其核心论点是，高斯过程提供了校准的不确定性量化，这在我们的贝叶斯优化框架中是必不可少的。本部分由两章组成：

+   第二章显示高斯过程是从一些观察数据中学习回归模型的自然解决方案。高斯过程定义了函数的分布，并且可以根据一些观察数据来更新以反映我们对函数值的信念。

+   第三章介绍了我们将先验信息合并到高斯过程中的两种主要方式：均值函数和协方差函数。均值函数指定了一般趋势，而协方差函数指定了函数的平滑程度。

第二部分列举了贝叶斯优化策略，这些策略是关于如何进行函数评估的决策过程，以便尽可能高效地确定全局最优值。虽然不同的策略由不同的目标驱动，但它们都旨在平衡探索和利用之间的权衡。这部分由三章组成：

+   第四章讨论了一种自然的方法来决定哪个函数评估是最有利的：考虑从当前最佳函数值中获得的改进。由于基于高斯过程的对函数的信念，我们可以计算这些与改进相关的数量，并且可以在封闭形式下廉价地进行，从而实现了两种特定的贝叶斯优化策略：改进的概率和预期改进。

+   第五章探讨了贝叶斯优化与另一种常见的问题类别之间的联系，称为*多臂老虎机*。我们学习如何将多臂老虎机策略转换为贝叶斯优化设置，并获得相应的策略：上置信界和汤普森采样。

+   第六章考虑了一种减少我们对函数全局最优值信念中不确定性的策略。这构成了基于熵的策略，使用了一种称为*信息论*的数学子领域。

第三部分介绍了一些最常见的用例，这些用例不能很好地适应本书迄今为止开发的工作流程，并展示了如何修改贝叶斯优化来解决这些优化任务：

+   第七章介绍了批量优化，在这种情况下，为了提高吞吐量，我们允许实验并行运行。例如，可以同时在一组 GPU 上并行训练大型神经网络的多个实例。这需要优化策略同时返回多个建议。

+   第八章讨论了安全关键的用例，我们在这些情况下不能自由地探索搜索空间，因为一些函数评估可能会产生不利影响。这促使了这样一种设置，即对于所讨论的函数如何行为有一定的约束，并且我们需要在优化策略的设计中考虑这些约束。

+   第九章表明，当我们可以以不同成本和精度级别观察函数值的多种方式时——通常称为*多信度贝叶斯优化*——考虑可变成本可以提高优化性能。

+   第十章涵盖了成对比较，已经显示出比数字评估或评级更准确地反映了个人偏好，因为它们更简单，对标注者的认知负荷较轻。第十章将贝叶斯优化扩展到此设置，首先使用特殊的高斯过程模型，然后修改现有策略以适应这个成对比较的工作流程。

+   一个人可能希望同时优化多个可能冲突的目标。第十一章研究了这个多目标优化问题，并展示了贝叶斯优化如何在这种情况下扩展。

第四部分涉及高斯过程模型的特殊变体，展示了它们在建模和提供不确定性校准预测方面的灵活性和效果，即使在贝叶斯优化环境之外也是如此：

+   在第十二章中，我们了解到在某些情况下，无法获得经过训练的高斯过程的闭合形式解。然而，可以使用复杂的近似策略进行高保真度的近似。

+   第十三章展示了由于 Torch 生态系统的存在，将 PyTorch 神经网络与 GPyTorch 高斯过程结合起来是一个无缝过程。这使得我们的高斯过程模型更加灵活和表达能力更强。

初学者将从前六章获益良多。有经验的从业者希望将贝叶斯优化应用于他们的案例中，可能会在第七章到第十一章中找到价值，这些章节可以独立阅读，任意顺序。长期使用高斯过程的用户很可能对最后两章感兴趣，我们在这些章节中开发了专门的高斯过程模型。

### 关于代码

您可以从本书的在线版本 [`livebook.manning.com/book/bayesian-optimization-in-action`](https://livebook.manning.com/book/bayesian-optimization-in-action) 获取可执行的代码片段。代码可以从 Manning 网站 [`www.manning.com/books/bayesian-optimization-in-action`](https://www.manning.com/books/bayesian-optimization-in-action) 和 GitHub [`github.com/KrisNguyen135/bayesian-optimization-in-action`](https://github.com/KrisNguyen135/bayesian-optimization-in-action) 下载；后者接受问题和拉取请求。

您将使用 Jupyter notebooks 来运行附带书籍的代码。Jupyter notebooks 提供了一种干净的方式来动态地使用代码，使我们能够探索每个对象的行为以及它与其他对象的交互。有关如何开始使用 Jupyter notebook 的更多信息，请查找它们的官方网站：[`jupyter.org`](https://jupyter.org)。在我们的情况下，动态探索对象的能力特别有帮助，因为 Bayesian 优化工作流的许多组件是由 GPyTorch 和 BoTorch 实现的 Python 对象。

GPyTorch 和 BoTorch 是 Python 中用于高斯过程建模和贝叶斯优化的首选库。还有其他选择，例如 scikit-Learn 的 scikit-optimize 扩展或 GPflow 和 GPflowOpt，它们扩展了 TensorFlow 框架用于贝叶斯优化。然而，GPyTorch 和 BoTorch 的组合构成了最全面和灵活的代码库，其中包括许多来自贝叶斯优化研究的最新算法。根据我自己使用贝叶斯优化软件的经验，我发现 GPyTorch 和 BoTorch 在易于初学者使用和提供最新方法之间取得了良好的平衡。

有一件事需要注意：正是因为这些库正在积极地维护，书中展示的 API 可能在新版本中略有变化，因此重要的是您按照`requirements.txt`文件中指定的库版本来运行代码，以避免错误。你可以在官方 Python 文档中找到更多关于如何使用`requirements.txt`文件创建 Python 环境的说明，例如在[`packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments`](https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments)。话虽如此，要使用新版本，您可能只需要对代码做些微小的修改。

当您阅读本书时，您会注意到文本往往只专注于代码的关键组件，省略了许多细节，比如库的导入和繁琐的代码。（当然，代码第一次使用时，它会在文本中被正确介绍。）简洁的讨论有助于我们专注于每一章中真正新颖的内容，避免重复。另一方面，Jupyter 笔记本中的代码是自包含的，可以单独运行每个笔记本，无需任何修改。

### liveBook 讨论论坛

购买《Bayesian Optimization in Action》包括免费访问 liveBook，Manning 的在线阅读平台。使用 liveBook 独有的讨论功能，您可以将评论附加到全书或特定的部分或段落上。您可以轻松地为自己做笔记，提出和回答技术问题，并从作者和其他用户那里获得帮助。要访问论坛，请转到[`livebook.manning.com/book/bayesian-optimization-in-action/discussion`](https://livebook.manning.com/book/bayesian-optimization-in-action/discussion)。您还可以在[`livebook.manning.com/discussion`](https://livebook.manning.com/discussion)了解更多关于 Manning 论坛和行为规则的信息。

Manning 对我们的读者的承诺是提供一个有意义的对话场所，既是个人读者之间的对话，也是读者与作者之间的对话。这并不是对作者参与的具体数量的承诺，他们对论坛的贡献仍然是自愿的（且未支付的）。我们建议您尝试向作者提出一些具有挑战性的问题，以免他们的兴趣消失！论坛和以前讨论的存档将在该书印刷期间都可以从出版商的网站上访问到。

## 关于作者

![](img/Nguyen_AuthorPhoto.png)

Quan Nguyen 是一位 Python 程序员和机器学习爱好者。他对解决涉及不确定性的决策问题感兴趣。Quan 撰写了几本关于 Python 编程和科学计算的书籍。他目前正在华盛顿大学圣路易斯分校攻读计算机科学博士学位，他在那里研究机器学习中的贝叶斯方法。

### 关于技术编辑

本书的技术编辑是 Kerry Koitzsch。Kerry 是一位作者，软件架构师，在企业应用程序和信息架构解决方案的实施方面拥有三十多年的丰富经验。Kerry 是一本关于分布式处理的书籍的作者，以及许多较短的技术出版物的作者，并拥有一项关于创新 OCR 技术的专利。他还是美国陆军成就奖的获得者。

## 关于封面插图

*Bayesian Optimization in Action* 封面上的图案标题为“波兰人”，摘自 Jacques Grasset de Saint-Sauveur 的一本 1797 年出版的作品集。每一幅插图都是手工精细绘制和上色的。

在那些日子里，通过人们的服装很容易辨别他们住在哪里，以及他们的行业或生活地位。Manning 凭借基于数个世纪前地区文化的丰富多样性的书籍封面，赞美了计算机业务的创造性和主动性，这些书籍封面是由这类集合中的图片重新唤起的。
